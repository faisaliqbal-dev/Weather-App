name: Build and Push Docker Image

on:
  push:
    branches:
      - main  

jobs:
  build-and-push:
    runs-on: ubuntu-latest  

    steps:
      # Step 1: Source code checkout
      - name:  Checkout source code
        uses: actions/checkout@v2

      # Step 2: Python environment setup
      - name:  Setup Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      # Step 3: Docker Buildx setup
      - name:  Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 4: Install Python dependencies
      - name:  Install app dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 5: Run flake8 linting test (optional, code quality)
      - name:  Run code linting with flake8
        run: |
          pip install flake8
          flake8 --ignore=E501,F401 .

      # Step 6: Login to DockerHub using secrets
      - name:  Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 7: Build Docker image with version and latest tags
      - name:  Build Docker image
        run: |
          docker build -t mohammedfaisaliqbal/weather-app:latest .
          docker tag mohammedfaisaliqbal/weather-app:latest mohammedfaisaliqbal/weather-app:latest

      # Step 8: Push both tags to DockerHub
      - name:  Push Docker image to DockerHub
        run: |
          docker push mohammedfaisaliqbal/weather-app:latest
